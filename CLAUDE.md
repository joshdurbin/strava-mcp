# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Development Commands

```bash
make build         # Build binary (outputs ./strava-mcp)
make test          # Run tests with 30s timeout
make test-cover    # Run tests with coverage report
make generate      # Regenerate sqlc database code from SQL files
make vet           # Run go vet
make deps          # Tidy go.mod dependencies
```

Run a single test:
```bash
go test -v -run TestName ./internal/package/...
```

## Architecture Overview

This is an MCP (Model Context Protocol) server that syncs Strava activities to a local SQLite database and exposes them via MCP tools for LLM access.

### Core Components

**Entry Point & CLI** (`main.go`, `internal/cmd/`)
- Uses Cobra for CLI commands (`root.go` defines flags, `run.go` contains main orchestration)
- Supports HTTP/SSE transport (port-based) or stdio transport (port=0) for MCP
- `--no-sync` flag runs MCP server in offline mode without Strava API connectivity

**MCP Server** (`internal/server/`)
- `server.go` - Core MCP server with activity query tools
- `metrics.go` - Metrics summary tools (distance, duration, calories, etc.)
- `zones.go` - Heart rate and power zone tools (requires Strava Summit)
- Tool handlers use sqlc-generated queries and return structured JSON responses

**Background Workers** (`internal/workers/`)
- `TokenRefresher` - Keeps OAuth tokens fresh (checks every 30m, refreshes if <10m to expiry)
- `ActivitySyncer` - Periodic delta sync from Strava API (uses latest activity date for incremental sync)
- `ZoneSyncer` - Syncs activity zone data in batches, respects API rate limits

**Database Layer** (`internal/db/`, `sql/`)
- SQLite with WAL mode for concurrent reads
- Database queries generated by sqlc from `sql/queries.sql`
- Schema lives in `sql/schema.sql`, migrations run in `internal/cmd/run.go:runMigration()`
- Run `make generate` after modifying SQL files

**Strava Integration** (`internal/strava/`, `internal/auth/`, `internal/sync/`)
- OAuth flow with browser-based authentication (`internal/auth/oauth.go`)
- Token storage in database via `internal/auth/storage.go`
- API client with retry/backoff and rate limit handling (`internal/strava/client.go`)
- Activity sync converts Strava API responses to DB params (`internal/sync/sync.go`)

### Data Flow

1. On startup: Load config → Open DB → Run migrations → Ensure OAuth authentication
2. Initial sync fetches all/new activities from Strava API
3. Background workers run concurrently: token refresh, activity sync, zone sync
4. MCP server exposes 20+ tools for querying stored data

### Key Patterns

- All database queries use sqlc-generated code - modify `sql/queries.sql` and run `make generate`
- MCP tool inputs/outputs are typed structs with JSON schema tags for automatic schema generation
- Background workers check context cancellation and use graceful shutdown with WaitGroup

### Strava API Rate Limits

Strava enforces rate limits (see https://developers.strava.com/docs/rate-limits/):
- Read endpoints: 100 requests per 15-minute window, 1,000 per day
- 15-minute windows reset at 0, 15, 30, 45 minutes past the hour
- Daily limits reset at midnight UTC
- Rate limit info returned in `X-RateLimit-Limit` and `X-RateLimit-Usage` headers

**Rate limit handling** (`internal/strava/client.go`):
- `parseRateLimitHeaders()` extracts usage from every API response
- `timeUntilNext15MinWindow()` calculates time until next 15-min boundary
- `timeUntilMidnightUTC()` calculates time until daily reset
- `WaitForRateLimit()` blocks until rate limit window resets
- Workers check limits before each batch and wait for window resets instead of failing
- Zone syncer continues syncing across multiple 15-min windows until daily limit approached
